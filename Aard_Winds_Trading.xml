<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Sunday, March 04, 2018, 11:59 AM -->
<!-- MuClient version 5.06-pre -->

<!-- Plugin "Aard_Winds_Trading" generated by Plugin Wizard -->

<!--
commentz
-->

<muclient>
<plugin
   name="Aard_Winds_Trading"
   author="Cynik"
   id="37e6ff68b2a5aeaeaab885a6"
   language="Lua"
   purpose="Trading winds cards."
   save_state="y"
   date_written="2018-03-04 11:58:44"
   requires="4.30"
   version="1.0"
   >
<description trim="y">
<![CDATA[
descripz
]]>
</description>

</plugin>


<!--  Triggers  -->

<triggers>
  <trigger
   name="case"
   enabled="y"
   regexp="y"
   match="^You have the following cards stored:$"
   script="start_case"
   sequence="100"
   omit_from_output="n"
  >
  </trigger>
  <trigger
   group="case"
   enabled="n"
   regexp="y"
   match="^\| Name\s+: A Fantasy Series Card (?<case>.+\w)\s+\|$"
   script="set_case"
   sequence="100"
   omit_from_output="n"
  >
  </trigger>
  <trigger
   group="case"
   enabled="n"
   regexp="y"
   match="^(?<card>\w+) Fantasy Series Collector's Card$"
   script="card"
   sequence="100"
   omit_from_output="n"
  >
  </trigger>
  <trigger
   group="case"
   enabled="n"
   regexp="y"
   match="^\| Id\s+: (?<id>\d+)\s+\|$"
   script="end_case"
   sequence="100"
   omit_from_output="n"
  >
  </trigger>
  
  
  <trigger
   name="extras"
   enabled="y"
   regexp="y"
   match="^You are carrying:$|^.+ contains:$"
   script="start_extras"
   sequence="100"
   omit_from_output="n"
  >
  </trigger>
  <trigger
   group="extras"
   enabled="n"
   regexp="y"
   match="^(\(\s?(?<count>\d+)\))?(\s+\([\(\)a-zA-Z\s]+\)) (?<card>\w+) Fantasy Series Collector's Card \(201\)$"
   script="extra_card"
   sequence="100"
   omit_from_output="n"
  >
  </trigger>
  <trigger
   group="extras"
   enabled="n"
   regexp="y"
   match="^[^\(\s].+$"
   script="end_extras"
   sequence="100"
   omit_from_output="n"
  >
  </trigger>
</triggers>

<!--  Aliases  -->

<aliases>
  <alias
   name="upload"
   match="^(?<yes>yes)|no$"
   enabled="n"
   regexp="y"
   script="upload_extras"
   sequence="100"
  >
  </alias>
  <alias
   name="update"
   match="^wtupdate$"
   enabled="y"
   regexp="y"
   script="download_update"
   sequence="100"
  >
  </alias>
</aliases>

<!--  Script  -->


<script>
<![CDATA[
require "tprint"
local https = require("ssl.https")
local ltn12 = require("ltn12")

local resp, code, headers, status
local response = {}
local cards, extras = {}, {}
local me, id, case
local tag

function upload_extras(name, line, args)
	
	EnableAlias("upload", false)
	
	tag = nil
	
	if args.yes == "yes" then
		local url = "https://winds.clansite.org/easy/?"..me
		local data = "player="..me.."&extras="..table.concat(extras, ",")

		--Note(data)
		resp, code, headers, status = https.request { 
			url = url,
			method = "POST",
			headers = {
				["Authorization"] = "Cynik=best",
				["Content-Type"] = "application/x-www-form-urlencoded",
				["Content-Length"] = #data
			},
			source = ltn12.source.string(data),
			sink = ltn12.sink.table(response)
		}
		DoAfterSpecial(.2, "check_response()", 12)	
	else
		Note()
		ColourNote("#FBFF00", "", "[", "#9AC7FE", "", "Winds Trading", "#FBFF00", "", "]", "white", "", " You chose not to upload extras.")
		Note()
	end
end

function expire_alias(t)
	if t == tag then
		EnableAlias("upload", false)
		Note()
		ColourNote("#FBFF00", "", "[", "#9AC7FE", "", "Winds Trading", "#FBFF00", "", "]", "white", "", " Extras upload alias has expired.")
		Note()
	end
end

function start_extras()
	if not me then
		any, me = CallPlugin("3e7dedbe37e44942dd46d264", "gmcpval", "char.base.name")
	end
	response = {}
	extras = {}
	EnableTriggerGroup("extras")
end

function extra_card(name, line, args)
	args.count = tonumber(args.count) or 1
	for i = 1, args.count do
		table.insert(extras, args.card)
	end
end

function end_extras()
	EnableTriggerGroup("extras", false)
	
	if #extras == 0 then
		return
	end
	
	EnableAlias("upload")
	Note()
	ColourNote("gray", "", string.rep("-", 80))
	ColourNote("#FBFF00", "", "[", "#9AC7FE", "", "Winds Trading", "#FBFF00", "", "]", "white", "", " You have "..#extras.." extra cards. Submit ", "yellow", "", "yes", "white", "", " to upload, or ", "yellow", "", "no", "white", "", " to cancel.")
	ColourNote("gray", "", string.rep("-", 80))
	Note()
	
	tag = os.time()
	DoAfterSpecial(30, "expire_alias("..tag..")", 12)
	
end

function start_case()
	if not me then
		any, me = CallPlugin("3e7dedbe37e44942dd46d264", "gmcpval", "char.base.name")
	end
	EnableTriggerGroup("case")
	resp, code, headers, status = nil, nil, nil, nil
	response = {}
	cards = {}
end

function card(name, line, args)
	table.insert(cards, args.card)
end

function set_case(name, line, args)
	case = string.gsub(args.case, "%&", "%%26")
end

function end_case(name, line, args)
	
	EnableTriggerGroup("case", false)
	
	if #cards == 0 then
		return
	end
	
	id = args.id
	local url = "https://winds.clansite.org/easy/?"..me
	local data = "player="..me.."&case="..case.."&id="..id.."&cards="..table.concat(cards, ",")

	--Note(data)
	resp, code, headers, status = https.request { 
		url = url,
		method = "POST",
		headers = {
			["Authorization"] = "Cynik=best",
			["Content-Type"] = "application/x-www-form-urlencoded",
			["Content-Length"] = #data
		},
		source = ltn12.source.string(data),
		sink = ltn12.sink.table(response)
	}
	DoAfterSpecial(.2, "check_response()", 12)
end

function check_response()
	if not code then -- probably not possible but eh
		--Note("No response yet.")
		DoAfterSpecial(.2, "check_response()", 12)
		return
	end
	if not response[1] then
		Note("There seems to be a problem with the server response.")
		return
	end
	local msgs = loadstring("return "..response[1])()
	Note()
	for i, msg in ipairs(msgs) do
		ColourNote("#FBFF00", "", "[", "#9AC7FE", "", "Winds Trading", "#FBFF00", "", "]", "white", "", " "..msg)
	end
	ColourTell("#FBFF00", "", "[", "#9AC7FE", "", "Winds Trading", "#FBFF00", "", "]", "white", "", " View your cases and extra cards here:  ")
	Hyperlink("https://winds.clansite.org/case/view/?player="..me, "https://winds.clansite.org/case/view/?player="..me, "", "#FBFF00", "", true)
	Note()
	Note()
end

function help()
	Note()
	ColourNote("gray", "", string.rep("-", 80))
	ColourNote("#FBFF00", "", "[", "#9AC7FE", "", "Winds Trading", "#FBFF00", "", "]")
	ColourNote("gray", "", string.rep("-", 80))
	ColourNote("white", "", "This plugin will upload your cases and extra cards. Just identify the case and \nthe plugin does the rest.  For extra cards, look in your inventory or a bag and \nyou will have the option to upload or not. The alias expires after 30 seconds.")
	ColourNote("white", "", "(Extras are reset at every look, so they all must be in the same location.)")
	ColourNote("white", "", "You can update this plugin from the GitHub source by submitting ", "yellow", "", "wtupdate", "white", "", ".")
	ColourNote("gray", "", string.rep("-", 80))
	Note()
end

function download_update()
	ColourNote("#FBFF00", "", "[", "#9AC7FE", "", "Winds Trading", "#FBFF00", "", "]", "white", "", " Downloading update, please wait.")
	local xml, code = https.request("https://raw.githubusercontent.com/aardlyworthit/winds_trading/master/Aard_Winds_Trading.xml")
	local path = GetPluginInfo(GetPluginID(), 6)

	ColourNote("#FBFF00", "", "[", "#9AC7FE", "", "Winds Trading", "#FBFF00", "", "]", "white", "", " Overwriting existing plugin file.")
	local file = assert(io.open(path, "w"))
	file:write(xml)
	file:close()
	ColourNote("#FBFF00", "", "[", "#9AC7FE", "", "Winds Trading", "#FBFF00", "", "]", "white", "", " Done. Reloading plugin now.")
	Execute(GetAlphaOption("script_prefix").."DoAfterSpecial(.2, \"ReloadPlugin('"..GetPluginID().."')\", 12)")
end

DoAfterSpecial(.2, "help()", 12)

]]>
</script>


</muclient>
